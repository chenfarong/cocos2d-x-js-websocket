{"version":3,"sources":["../../../../assets/Script/assets/Script/Network.js"],"names":["WebSocket","window","MozWebSocket","XNet","cc","Class","extends","Component","statics","_socket","ws_host","_netPros","Map","_netEars","Array","_connectTimeout","_wsReConnectTimes","_reConnectFlag","_reConnectMax","dispatchXNet","event","msg","forEach","item","index","array","netEvent","listeners","slice","i","length","callback","target","host","uri","connect","readyState","OPEN","console","log","onopen","_onOpen","bind","onerror","_onError","onclose","_onClose","onmessage","_onMessage","disconnect","nil","xx_opcodes","XC_NET_CONNECTED","cmd","rc","error","XC_NET_ERROR","XC_NET_DISCONNECTED","JSON","parse","data","ListenerAdd","listenerList","push","ListenerRemove","splice","EarAdd","ear","EarRemove","pos","indexOf","connectCheck","CONNECTING","XC_NET_CONNECT_TIMEOUT","CLOSED","sendString","text","send"],"mappings":"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","file":"Network.js","sourceRoot":"../../../../assets/Script","sourcesContent":["var WebSocket = WebSocket || window.WebSocket || window.MozWebSocket;\n\n\nimport {xx_opcodes} from './Opcodes';\n\n//个人采用文本方式来收发数据\n//频率高的采用二进制数据进行收发 例如 移动数据包\n\nvar XNet = cc.Class ({\nextends : cc.Component,\nstatics:{\n    _socket:{},\n    ws_host:\"ws://test.9966886699.com:8086/game\",\n    _netPros:new Map(),\n    _netEars:new Array(),\n    _connectTimeout:5,\n    _wsReConnectTimes:0,\n    _reConnectFlag:false,\n    _reConnectMax:3,\n\n    dispatchXNet(event,msg){\n\n//        XGame.DoXEvent(event,msg);\n        \n        this._netEars.forEach(function(item,index,array){\n            item.netEvent(event,msg);\n        });\n        \n\n        if(this._netPros[event])\n        {\n            var listeners=this._netPros[event].slice();\n            for(var i=0;i<listeners.length;i++){\n                listeners[i].callback(msg,listeners[i].target);\n            }\n        }\n    },\n    \n    host:function(uri){\n        this.ws_host=uri;\n    },\n\n    connect:function()\n    {\n        if(this._socket.readyState!=WebSocket.OPEN){\n            console.log(\"connect \"+this.ws_host);\n//            if(this._socket!=null) delete this._socket;\n\n            this._socket=new WebSocket(this.ws_host);\n            this._socket.onopen=this._onOpen.bind(this);\n            this._socket.onerror=this._onError.bind(this);\n            this._socket.onclose=this._onClose.bind(this);\n            this._socket.onmessage=this._onMessage.bind(this);\n\n            //cc.director.getScheduler().schedule(this.connectTimeoutCheck,this,1, 5, 3,false);\n\n        }\n        return this;\n    },\n\n    disconnect()\n    {\n        if(this._socket &&this._socket.readyState==1)\n        {\n            delete this._socket;\n            this._socket=nil;\n            //cc.director.getScheduler().\n        }\n    },\n\n    readyState(){\n        if(this._socket) return this._socket.readyState;\n        return -1;\n    },\n\n    _onOpen:function(event)\n    {\n        console.log(\"connected \"+this.ws_host);\n        //utils.OutObj(evt);\n        //var event = new cc.Event(this,\"Network\",true);\n        //event.setUserData(\"{...}\");\n        //cc.eventTarget.dispatchEvent(event);\n       // cc.EventTarget.dispatchEvent(\"adas\",\"123\",evt); \n       \n       //\n       //cc.eventManager.dispatchCustomEvent(\"XNetOpened\", {a:1,b:2});\n\n       //var event=new cc.EventCustom(\"XNetOpened\");\n       //cc.SystemEvent.dispatchCustomEvent(event);\n       XNet.dispatchXNet(xx_opcodes.XC_NET_CONNECTED,{cmd:xx_opcodes.XC_NET_CONNECTED,rc:0});\n        \n\n    },\n\n\n    _onError:function(event)\n    {\n        console.error(\"WebSocket error observed:\", event);\n        //if(_reConnectFlag)\n        //{\n        //    connect();\n        //}\n        XNet.dispatchXNet(xx_opcodes.XC_NET_ERROR,{cmd:xx_opcodes.XC_NET_ERROR,rc:event});\n    },\n\n    _onClose:function(event)\n    {\n        console.log(\"WebSocket is closed now.\");\n        XNet.dispatchXNet(xx_opcodes.XC_NET_DISCONNECTED,{cmd:xx_opcodes.XC_NET_DISCONNECTED,rc:0});\n    },\n\n    _onMessage:function(event)\n    {\n       // console.debug(\"WebSocket message received:\", event);\n        //let str = event.data;\n        let msg = JSON.parse(event.data);\n        console.log(msg.cmd);\n        XNet.dispatchXNet(msg.cmd,msg);\n    },\n\n\n    ListenerAdd(event,callback)\n    {\n        if(!event|| !callback) return;\n        var listenerList=this._netPros[event];\n        if(!listenerList) listenerList=this._netPros[event]=new Array();\n        for(var i=0;i<listenerList.length;i++)\n        {\n            if(listenerList[i]==callback) return;\n        }\n        listenerList.push(callback);\n    },\n\n    ListenerRemove(event,callback){\n        if(!event|| !callback) return;\n        var listenerList=this._netPros[event];\n        if(listenerList){\n            for(var i=0;i<listenerList.length;i++)\n            {\n                if(listenerList[i]==callback){ \n                    listenerList.splice(i,1);\n                    return;\n                }\n            }\n        }        \n    },\n\n    EarAdd(ear){\n        this._netEars.push(ear);\n    },\n\n    EarRemove(ear){\n        let pos=this._netEars.indexOf(ear);\n        this._netEars.splice(pos,1);\n    },\n\n    connectCheck:function(){\n\n        if(this._socket==null) return;\n\n        if(  this._socket.readyState == WebSocket.CONNECTING){\n            console.log(\"websocket connect timeout\");\n            XNet.dispatchXNet(xx_opcodes.XC_NET_CONNECT_TIMEOUT,{cmd:xx_opcodes.XC_NET_CONNECT_TIMEOUT,rc:0});\n            this.connect();\n        }\n\n        if( this._socket.readyState==WebSocket.CLOSED){\n            console.log(\"websocket reconnect\");\n            //this.connect();\n        }\n\n     },\n \n     sendString:function(text)\n     {\n        if(this._socket.readyState==WebSocket.OPEN){\n            \n            this._socket.send(text);\n        }\n     },\n\n},\n\n\n\n});\n\nexport {XNet};"]}